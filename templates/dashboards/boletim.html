{% extends 'base.html' %}
{% load static %}

{% block title %}Boletim Escolar | SENAI{% endblock %}

{% block content %}
<div class="layout-wrapper d-flex bg-light">
    {% include 'includes/sidebar.html' %}

    <div id="main-content" class="flex-grow-1 transition-all">
        
        <header class="bg-white sticky-top shadow-sm py-3 px-4 d-print-none">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-light d-md-none shadow-sm" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1 class="header-title mb-0 h5"><i class="fas fa-file-invoice me-2 text-primary"></i>Boletim Escolar</h1>
                </div>
            </div>
        </header>

        <div class="container-fluid p-4">
            
            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-2 bg-primary text-white d-flex flex-column align-items-center justify-content-center p-4 text-center">
                            <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center shadow-sm mb-3" style="width: 80px; height: 80px; font-size: 2rem; fw-bold">
                                {{ aluno.user.first_name|first }}
                            </div>
                            <small class="opacity-75 text-uppercase" style="letter-spacing: 1px;">Aluno</small>
                        </div>
                        
                        <div class="col-md-7 p-4 d-flex flex-column justify-content-center">
                            <h3 class="fw-bold text-dark mb-1">{{ aluno.user.get_full_name }}</h3>
                            <div class="d-flex flex-wrap gap-4 mt-2 text-muted">
                                <div><i class="fas fa-id-card me-2 text-primary"></i>RA: <strong>{{ aluno.RA_aluno }}</strong></div>
                                <div><i class="fas fa-graduation-cap me-2 text-primary"></i>Curso: <strong>{{ aluno.turma_atual.id_curso.nome_curso }}</strong></div>
                                <div><i class="fas fa-users me-2 text-primary"></i>Turma: <strong>{{ aluno.turma_atual.nome }}</strong></div>
                            </div>
                        </div>

                        <div class="col-md-3 bg-light border-start p-4 d-flex flex-column align-items-center justify-content-center">
                            <small class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.75rem;">Coeficiente (CR)</small>
                            <div class="display-5 fw-bold {% if cr_geral >= 7 %}text-success{% elif cr_geral >= 5 %}text-warning{% else %}text-danger{% endif %}">
                                {{ cr_geral|floatformat:1 }}
                            </div>
                            <small class="text-muted text-center" style="font-size: 0.7rem;">Média Global</small>
                        </div>
                    </div>
                </div>
            </div>

            {% if boletim_por_periodo %}
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white border-bottom pt-3 pb-0 px-4">
                        <ul class="nav nav-tabs card-header-tabs" id="boletimTabs" role="tablist">
                            {% for periodo in boletim_por_periodo.keys %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link {% if forloop.last %}active{% endif %} fw-bold" 
                                        id="tab-{{ periodo|slugify }}" 
                                        data-bs-toggle="tab" 
                                        data-bs-target="#content-{{ periodo|slugify }}" 
                                        type="button" 
                                        role="tab">
                                    {{ periodo }}
                                </button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="card-body p-0">
                        <div class="tab-content" id="boletimTabsContent">
                            {% for periodo, historicos in boletim_por_periodo.items %}
                            <div class="tab-pane fade {% if forloop.last %}show active{% endif %}" id="content-{{ periodo|slugify }}" role="tabpanel">
                                
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="bg-light text-secondary small text-uppercase">
                                            <tr>
                                                <th class="ps-4 py-3">Disciplina</th>
                                                <th class="py-3">Professor</th>
                                                <th class="text-center py-3" style="width: 100px;">Faltas</th>
                                                <th class="text-center py-3" style="width: 150px;">Frequência</th>
                                                <th class="text-center py-3" style="width: 120px;">Nota Final</th>
                                                <th class="text-end pe-4 py-3" style="width: 140px;">Situação</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for h in historicos %}
                                            <tr>
                                                <td class="ps-4">
                                                    <div class="fw-bold text-dark">{{ h.disciplina_nome }}</div>
                                                </td>
                                                <td class="text-muted small">
                                                    {{ h.professor_nome }}
                                                </td>
                                                <td class="text-center text-muted fw-medium">
                                                    {{ h.total_faltas|default:"0" }}
                                                </td>
                                                <td class="text-center">
                                                    {% if h.frequencia_percentual is not None %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            <div class="progress rounded-pill w-100 mb-1" style="height: 6px; background-color: #e9ecef;">
                                                                <div class="progress-bar rounded-pill bg-{% if h.frequencia_percentual < 75 %}danger{% else %}success{% endif %}" 
                                                                     role="progressbar" 
                                                                     style="width: {{ h.frequencia_percentual|floatformat:0 }}%">
                                                                </div>
                                                            </div>
                                                            <small class="fw-bold {% if h.frequencia_percentual < 75 %}text-danger{% else %}text-success{% endif %}" style="font-size: 0.75rem;">
                                                                {{ h.frequencia_percentual|floatformat:0 }}%
                                                            </small>
                                                        </div>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if h.media_final is not None %}
                                                        <span class="badge rounded-pill bg-{{ h.cor_status }} px-3 py-2 fs-6 fw-normal shadow-sm">
                                                            {{ h.media_final|floatformat:1 }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-light text-muted border">--</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end pe-4">
                                                    {% if h.media_final is not None %}
                                                        {% if h.media_final >= 7 and h.frequencia_percentual >= 75 %}
                                                            <span class="text-success fw-bold small"><i class="fas fa-check-circle me-1"></i>Aprovado</span>
                                                        {% elif h.media_final >= 5 %}
                                                            <span class="text-warning fw-bold small"><i class="fas fa-exclamation-circle me-1"></i>Recuperação</span>
                                                        {% else %}
                                                            <span class="text-danger fw-bold small"><i class="fas fa-times-circle me-1"></i>Reprovado</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-primary fw-bold small"><i class="fas fa-spinner fa-spin me-1"></i>Cursando</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="bg-light border-top p-3 text-end text-muted small">
                                    <span class="me-3">Disciplinas no período: <strong>{{ historicos|length }}</strong></span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-3 opacity-25">
                        <i class="fas fa-file-alt fa-4x text-muted"></i>
                    </div>
                    <h5 class="text-muted fw-bold">Nenhum registro acadêmico disponível</h5>
                    <p class="text-muted small">Suas notas e faltas aparecerão aqui assim que forem lançadas pelos professores.</p>
                </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
    /* Estilos de Impressão */
    @media print {
        @page { size: landscape; margin: 1cm; }
        body { background: white !important; -webkit-print-color-adjust: exact; }
        #sidebar, .d-print-none, .btn { display: none !important; }
        #main-content { margin: 0 !important; padding: 0 !important; width: 100% !important; }
        .card { border: none !important; box-shadow: none !important; }
        .tab-content > .tab-pane { display: block !important; opacity: 1 !important; margin-bottom: 2rem; page-break-inside: avoid; }
        .nav-tabs { display: none !important; } /* Esconde as abas e mostra conteúdo sequencial */
        .progress { border: 1px solid #ccc; }
        .badge { border: 1px solid #000; color: #000 !important; background: none !important; }
    }
</style>
{% endblock %}